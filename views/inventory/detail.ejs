<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
 
  <main class="detail-container" id="main">
    <div class="detail-grid" role="region" aria-labelledby="vehicle-heading">
      <div class="vehicle-image" aria-hidden="false">
        <% if (vehicle.inv_image) { %>
          <img src="<%= vehicle.inv_image %>" alt="<%= vehicle.inv_make %> <%= vehicle.inv_model %> full image">
        <% } else { %>
          <img src="/images/vehicles/no-image.png" alt="No image available">
        <% } %>
      </div>

      <div class="vehicle-info">
        <h1 id="vehicle-heading" class="vehicle-title">
          <%= vehicle.inv_make %> <%= vehicle.inv_model %> (<%= vehicle.inv_year %>)
        </h1>

        <div class="vehicle-price" aria-live="polite">
          $<%= new Intl.NumberFormat('en-US').format(vehicle.inv_price) %>
        </div>

        <ul class="vehicle-specs" aria-label="Vehicle specifications">
          <li><strong>Mileage:</strong> <%= new Intl.NumberFormat('en-US').format(vehicle.inv_miles) %> miles</li>
          <li><strong>Color:</strong> <%= vehicle.inv_color %></li>
        </ul>

        <section class="vehicle-description" aria-label="Vehicle description">
          <h2>Overview</h2>
          <p><%= vehicle.inv_description || 'No description available.' %></p>
        </section>

        <!-- Favorite Button (only show if logged in) -->
        <% if (locals.loggedin) { %>
          <div class="favorite-section">
            <% if (locals.isFavorited) { %>
              <button class="favorite-btn favorited" data-inv-id="<%= vehicle.inv_id %>" id="favoriteBtn">
                ‚ù§Ô∏è Remove from Favorites
              </button>
            <% } else { %>
              <button class="favorite-btn" data-inv-id="<%= vehicle.inv_id %>" id="favoriteBtn">
                ü§ç Add to Favorites
              </button>
            <% } %>
          </div>
        <% } else { %>
          <p class="login-prompt"><a href="/account/login">Login</a> to add this vehicle to your favorites</p>
        <% } %>

        <!-- Optional extra HTML from utilities -->
        <div class="vehicle-extra">
          <%- detailView %>
        </div>
      </div>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <% if (locals.loggedin) { %>
  <script>
    // Handle favorite button click
    document.getElementById('favoriteBtn').addEventListener('click', async function() {
      const invId = this.getAttribute('data-inv-id');
      const isFavorited = this.classList.contains('favorited');
      const endpoint = isFavorited ? '/favorites/remove' : '/favorites/add';
      
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ inv_id: invId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Reload page to update button state
          location.reload();
        } else {
          alert('Action failed. Please try again.');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred');
      }
    });
  </script>
  <% } %>
</body>
</html>